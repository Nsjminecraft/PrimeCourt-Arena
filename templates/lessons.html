{% extends "base.html" %}

{% block head %}
{{ super() }}
<script src="https://js.stripe.com/v3/"></script>
<style>
  /* Hide base-level flash alerts on this page when not showing booking result */
  {% if not request.args.get('show_flash') %}
  body > .container > .alert { display: none !important; }
  {% endif %}

  .calendar-arrow-btn {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
  }
  .calendar-table {
      width: 100%;
      text-align: center;
  }
  .calendar-day-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: 2px solid transparent;
      background-color: #f0f0f0;
      cursor: pointer;
  }
  .calendar-day-btn.active {
      border-color: #007bff;
      background-color: #e0efff;
  }
  .calendar-day-past {
      background-color: #f8f9fa;
      color: #6c757d;
      cursor: not-allowed;
  }
  .lesson-type-option label {
      display: flex;
      align-items: center;
      padding: 15px;
      border: 2px solid #dee2e6;
      border-radius: 8px;
      cursor: pointer;
  }
  .lesson-type-option input[type="radio"]:checked + label {
      border-color: #4CAF50;
      background-color: #f0f9f0;
  }
  .time-slots {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 10px;
  }
  .time-slot-btn {
      padding: 10px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      cursor: pointer;
  }
  .time-slot-btn.selected {
      border-color: #4CAF50;
      background-color: #e8f5e9;
  }
  .time-slot-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
  }
  .loading .spinner-border { display: inline-block !important; }
  .loading .btn-text { visibility: hidden; }
  #payment-error:not(.d-none) { display: block; }
</style>
{% endblock %}

{% block content %}
<div class="container section">
    <div class="section-header">
        <h1>Badminton Lessons</h1>
    </div>

    <div id="booking-success-alert" class="alert alert-success d-none" role="alert">
        <h4 class="alert-heading">Booking Successful!</h4>
        <p>Your lesson has been successfully booked. A confirmation email has been sent to you. You can view your booking on your <a href="{{ url_for('profile') }}" class="alert-link">profile page</a>.</p>
    </div>
    <div id="booking-cancelled-alert" class="alert alert-warning d-none" role="alert">
        Your booking was cancelled. You can try booking again anytime.
    </div>

    <h3>
        <form method="get" action="{{ url_for('lessons') }}" style="display:inline;">
            <input type="hidden" name="month" value="{{ month - 1 if month > 1 else 12 }}">
            <input type="hidden" name="year" value="{{ year if month > 1 else year - 1 }}">
            <button type="submit" class="calendar-arrow-btn">&#8592;</button>
        </form>
        {{ month_name }} {{ year }}
        <form method="get" action="{{ url_for('lessons') }}" style="display:inline;">
            <input type="hidden" name="month" value="{{ month + 1 if month < 12 else 1 }}">
            <input type="hidden" name="year" value="{{ year if month < 12 else year + 1 }}">
            <button type="submit" class="calendar-arrow-btn">&#8594;</button>
        </form>
    </h3>

    <table class="calendar-table my-4">
        <thead>
            <tr>
                <th>Sun</th><th>Mon</th><th>Tue</th><th>Wed</th><th>Thu</th><th>Fri</th><th>Sat</th>
            </tr>
        </thead>
        <tbody>
            {% set ns = namespace(day_ptr=0) %}
            {% set today_str = now.strftime('%Y-%m-%d') %}
            {% for week in range(6) %}
            <tr>
                {% for wd in range(7) %}
                    {% if week == 0 and wd < weekday %}
                        <td></td>
                    {% elif ns.day_ptr < lesson_days|length %}
                        {% set day = lesson_days[ns.day_ptr] %}
                        {% set is_past = day.date < today_str %}
                        <td>
                            <a href="{{ url_for('lessons', year=year, month=month, day=ns.day_ptr) }}" 
                               class="btn calendar-day-btn{% if selected_day_idx|int == ns.day_ptr %} active{% endif %}{% if is_past %} calendar-day-past{% endif %}" 
                               {% if is_past %}aria-disabled="true" onclick="return false;"{% endif %}>
                                {{ day.date.split('-')[2] }}
                            </a>
                        </td>
                        {% set ns.day_ptr = ns.day_ptr + 1 %}
                    {% else %}
                        <td></td>
                    {% endif %}
                {% endfor %}
            </tr>
            {% endfor %}
        </tbody>
    </table>

    {% if selected_day %}
        {% if selected_day.no_classes %}
            <div class="alert alert-info">No classes on this day: {{ selected_day.no_classes_reason }}</div>
        {% else %}
            <form id="lesson-booking-form">
                <input type="hidden" name="day_idx" value="{{ selected_day_idx }}">
                <input type="hidden" name="slot_idx" id="slot_idx_select" value="">

                <div class="form-group">
                    <h5>1. Select Lesson Type</h5>
                    <div class="lesson-type-selector">
                        {% for type in lesson_types %}
                        <div class="lesson-type-option">
                            <input type="radio" id="lesson_type_{{ type.id }}" name="lesson_type" value="{{ type.id }}" data-price="{{ type.price }}">
                            <label for="lesson_type_{{ type.id }}">
                                <i class="fas fa-user"></i>
                                <span>{{ type.name }}</span>
                                <span class="price">${{ "%.2f"|format(type.price) }}</span>
                                <span class="badge">{{ type.capacity }} per slot</span>
                            </label>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <div class="form-group">
                    <h5>2. Choose a Slot</h5>
                    <div class="time-slots">
                        {% for slot in selected_day.slots %}
                            <button type="button" class="btn time-slot-btn" data-slot-idx="{{ loop.index0 }}" data-lesson-type="{{ 'private' if slot.private else 'group' }}" {% if slot.is_past or not slot.is_available %}disabled{% endif %}>
                                <div class="time">{{ slot.time }}</div>
                                {% if slot.private %}<span class="badge badge-private">Private</span>{% endif %}
                                {% if slot.group %}<span class="badge badge-group">{{ slot.group|length }} / 5</span>{% endif %}
                                {% if slot.is_past or not slot.is_available %}<span class="badge-unavailable">Unavailable</span>{% endif %}
                            </button>
                        {% endfor %}
                    </div>
                </div>

                <div class="form-group">
                    <h5>3. Your Details</h5>
                    <input type="text" id="student_name" name="student_name" class="form-control mb-2" placeholder="Your Name" value="{{ current_user.name if current_user.is_authenticated else '' }}" required>
                    <input type="email" id="student_email" name="student_email" class="form-control" placeholder="Your Email" value="{{ current_user.email if current_user.is_authenticated else '' }}" required>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary" id="book-now-btn" disabled>
                        <span class="btn-text">Book Slot</span>
                        <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                    </button>
                    <div id="payment-error" class="alert alert-danger mt-2 d-none"></div>
                </div>
            </form>
        {% endif %}
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const stripe = Stripe('{{ stripe_public_key }}');
    const form = document.getElementById('lesson-booking-form');
    if (!form) return;

    const bookNowBtn = document.getElementById('book-now-btn');
    const errorDiv = document.getElementById('payment-error');
    const studentNameInput = document.getElementById('student_name');
    const studentEmailInput = document.getElementById('student_email');
    const hiddenSlotInput = document.getElementById('slot_idx_select');

    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('status') === 'success') {
        document.getElementById('booking-success-alert').classList.remove('d-none');
    } else if (urlParams.get('status') === 'cancel') {
        document.getElementById('booking-cancelled-alert').classList.remove('d-none');
    }

    function updateButtonState() {
        const lessonTypeSelected = document.querySelector('input[name="lesson_type"]:checked');
        const slotSelected = document.querySelector('.time-slot-btn.selected');
        const nameFilled = studentNameInput.value.trim() !== '';
        const emailFilled = studentEmailInput.value.trim() !== '';
        bookNowBtn.disabled = !(lessonTypeSelected && slotSelected && nameFilled && emailFilled);
    }

    document.querySelectorAll('input[name="lesson_type"]').forEach(radio => {
        radio.addEventListener('change', updateButtonState);
    });

    document.querySelectorAll('.time-slot-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            if (this.disabled) return;
            document.querySelectorAll('.time-slot-btn.selected').forEach(b => b.classList.remove('selected'));
            this.classList.add('selected');
            hiddenSlotInput.value = this.dataset.slotIdx;
            updateButtonState();
        });
    });

    studentNameInput.addEventListener('input', updateButtonState);
    studentEmailInput.addEventListener('input', updateButtonState);

    form.addEventListener('submit', function(event) {
        event.preventDefault();
        bookNowBtn.classList.add('loading');
        bookNowBtn.disabled = true;
        errorDiv.classList.add('d-none');

        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());

        fetch('/create-lesson-booking', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data),
        })
        .then(response => response.json())
        .then(session => {
            if (session.error) {
                throw new Error(session.error);
            }
            return stripe.redirectToCheckout({ sessionId: session.sessionId });
        })
        .then(result => {
            if (result.error) {
                throw new Error(result.error.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            errorDiv.textContent = error.message || 'An error occurred while processing your booking.';
            errorDiv.classList.remove('d-none');
            window.scrollTo({
                top: errorDiv.offsetTop - 20,
                behavior: 'smooth'
            });
        })
        .finally(() => {
            bookNowBtn.disabled = false;
            bookNowBtn.classList.remove('loading');
        });
    });
});
</script>
{% endblock %}