{% extends "base.html" %}

{% block head %}
{{ super() }}
<script src="https://js.stripe.com/v3/"></script>
{% endblock %}

{% block content %}
<div class="container section">
    <div class="section-header">
        <h1>Badminton Lessons</h1>
    </div>

    <div id="booking-success-alert" class="alert alert-success d-none" role="alert">
        <h4 class="alert-heading">Booking Successful!</h4>
        <p>Your lesson has been successfully booked. A confirmation email has been sent to you. You can view your booking on your <a href="{{ url_for('profile') }}" class="alert-link">profile page</a>.</p>
    </div>
    <div id="booking-cancelled-alert" class="alert alert-warning d-none" role="alert">
        Your booking was cancelled. You can try booking again anytime.
    </div>

    <div class="calendar-header" style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
        <form method="get" action="{{ url_for('lessons') }}">
            <input type="hidden" name="month" value="{{ month - 1 if month > 1 else 12 }}">
            <input type="hidden" name="year" value="{{ year if month > 1 else year - 1 }}">
            <button type="submit" class="calendar-arrow-btn" aria-label="Previous Month">&#8592;</button>
        </form>
        <span class="calendar-month" style="font-size: 1.5rem; font-weight: bold;">{{ month_name }} {{ year }}</span>
        <form method="get" action="{{ url_for('lessons') }}">
            <input type="hidden" name="month" value="{{ month + 1 if month < 12 else 1 }}">
            <input type="hidden" name="year" value="{{ year if month < 12 else year + 1 }}">
            <button type="submit" class="calendar-arrow-btn" aria-label="Next Month">&#8594;</button>
        </form>
    </div>

    <table class="calendar-table my-4">
        <thead>
            <tr>
                <th>Sun</th><th>Mon</th><th>Tue</th><th>Wed</th><th>Thu</th><th>Fri</th><th>Sat</th>
            </tr>
        </thead>
        <tbody>
            {% set ns = namespace(day_ptr=0) %}
            {% set today_str = now.strftime('%Y-%m-%d') %}
            {% for week in range(6) %}
            <tr>
                {% for wd in range(7) %}
                    {% if week == 0 and wd < weekday %}
                        <td></td>
                    {% elif ns.day_ptr < lesson_days|length %}
                        {% set day = lesson_days[ns.day_ptr] %}
                        {% set is_past = day.date < today_str %}
                        <td>
                            <a href="{{ url_for('lessons', year=year, month=month, day=ns.day_ptr) }}" 
                               class="btn calendar-day-btn{% if selected_day_idx|int == ns.day_ptr %} active{% endif %}{% if is_past or day.no_classes %} calendar-day-past{% endif %}" 
                               {% if is_past or day.no_classes %}aria-disabled="true" onclick="return false;"{% endif %}>
                                {{ day.date.split('-')[2] }}
                            </a>
                        </td>
                        {% set ns.day_ptr = ns.day_ptr + 1 %}
                    {% else %}
                        <td></td>
                    {% endif %}
                {% endfor %}
            </tr>
            {% endfor %}
        </tbody>
    </table>

    {% if selected_day %}
        {% if selected_day.no_classes %}
            <div class="alert alert-info">No classes on this day: {{ selected_day.no_classes_reason }}</div>
        {% else %}
            <div class="lesson-container">
                <h2>Badminton Lessons</h2>
                <div class="lessons-card" style="max-width: 700px; width: 100%; min-width: 350px; margin: 0 auto; padding: 2.5rem 2rem; font-size: 1.15rem;">
                    <h1 class="lessons-title">Badminton Lessons</h1>
                    <!-- Booking form goes here -->
                    <div class="form-section">
                        <label><strong>Select Lesson Type:</strong></label><br>
                        <input type="radio" name="lesson_type" value="group"> Group Lesson (2-10) (per slot)<br>
                        <input type="radio" name="lesson_type" value="private"> Private Lesson (1-2) (per slot)<br>
                    </div>
                    <div class="form-section">
                        <label for="time_slot"><strong>Select Time Slot:</strong></label><br>
                        <select name="time_slot" id="time_slot">
                            <option value="">-- Select a time slot --</option>
                            {% for slot in selected_day.slots %}
                                <option value="{{ loop.index0 }}"
                                    {% if slot.is_past %}disabled style="color: #888;"{% endif %}>
                                    {{ slot.time }} (Group, {{ slot.group|length }} booked)
                                    {% if slot.is_past %} - Past{% endif %}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-section">
                        <label for="name"><strong>Your Name:</strong></label>
                        <input type="text" name="name" id="name">
                    </div>
                    <div class="form-section">
                        <label for="contact"><strong>Contact:</strong></label>
                        <input type="text" name="contact" id="contact">
                    </div>
                    <button type="submit" class="book-btn">Book Slot</button>
                </div>
            </div>
        {% endif %}
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const stripe = Stripe('{{ stripe_public_key }}');
    const form = document.getElementById('lesson-booking-form');
    if (!form) return;

    const bookNowBtn = document.getElementById('book-now-btn');
    const errorDiv = document.getElementById('payment-error');
    const studentNameInput = document.getElementById('student_name');
    const studentEmailInput = document.getElementById('student_email');
    const hiddenSlotInput = document.getElementById('slot_idx_select');

    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('status') === 'success') {
        document.getElementById('booking-success-alert').classList.remove('d-none');
    } else if (urlParams.get('status') === 'cancel') {
        document.getElementById('booking-cancelled-alert').classList.remove('d-none');
    }

    function updateButtonState() {
        const lessonTypeSelected = document.querySelector('input[name="lesson_type"]:checked');
        const slotSelected = document.querySelector('.time-slot-btn.selected');
        const nameFilled = studentNameInput.value.trim() !== '';
        const emailFilled = studentEmailInput.value.trim() !== '';
        bookNowBtn.disabled = !(lessonTypeSelected && slotSelected && nameFilled && emailFilled);
    }

    document.querySelectorAll('input[name="lesson_type"]').forEach(radio => {
        radio.addEventListener('change', updateButtonState);
    });

    document.querySelectorAll('.time-slot-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            if (this.disabled) return;
            document.querySelectorAll('.time-slot-btn.selected').forEach(b => b.classList.remove('selected'));
            this.classList.add('selected');
            hiddenSlotInput.value = this.dataset.slotIdx;
            updateButtonState();
        });
    });

    studentNameInput.addEventListener('input', updateButtonState);
    studentEmailInput.addEventListener('input', updateButtonState);

    form.addEventListener('submit', function(event) {
        event.preventDefault();
        bookNowBtn.classList.add('loading');
        bookNowBtn.disabled = true;
        errorDiv.classList.add('d-none');

        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());

        fetch('/create-lesson-booking', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data),
        })
        .then(response => response.json())
        .then(session => {
            if (session.error) {
                throw new Error(session.error);
            }
            return stripe.redirectToCheckout({ sessionId: session.sessionId });
        })
        .then(result => {
            if (result.error) {
                throw new Error(result.error.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            errorDiv.textContent = error.message || 'An error occurred while processing your booking.';
            errorDiv.classList.remove('d-none');
            window.scrollTo({
                top: errorDiv.offsetTop - 20,
                behavior: 'smooth'
            });
        })
        .finally(() => {
            bookNowBtn.disabled = false;
            bookNowBtn.classList.remove('loading');
        });
    });
});
</script>
{% endblock %}