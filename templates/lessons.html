{% extends "base.html" %}

{% block head %}
{{ super() }}
<script src="https://js.stripe.com/v3/"></script>
{% endblock %}

{% block content %}
<div class="container section">
    <div class="section-header">
        <h1>Badminton Lessons</h1>
    </div>

    <div id="booking-success-alert" class="alert alert-success d-none" role="alert">
        <h4 class="alert-heading">Booking Successful!</h4>
        <p>Your lesson has been successfully booked. A confirmation email has been sent to you. You can view your booking on your <a href="{{ url_for('profile') }}" class="alert-link">profile page</a>.</p>
    </div>
    <div id="booking-cancelled-alert" class="alert alert-warning d-none" role="alert">
        Your booking was cancelled. You can try booking again anytime.
    </div>

    <div class="calendar-header" style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
        <form method="get" action="{{ url_for('lessons') }}">
            <input type="hidden" name="month" value="{{ month - 1 if month > 1 else 12 }}">
            <input type="hidden" name="year" value="{{ year if month > 1 else year - 1 }}">
            <button type="submit" class="calendar-arrow-btn" aria-label="Previous Month">&#8592;</button>
        </form>
        <span class="calendar-month" style="font-size: 1.5rem; font-weight: bold;">{{ month_name }} {{ year }}</span>
        <form method="get" action="{{ url_for('lessons') }}">
            <input type="hidden" name="month" value="{{ month + 1 if month < 12 else 1 }}">
            <input type="hidden" name="year" value="{{ year if month < 12 else year + 1 }}">
            <button type="submit" class="calendar-arrow-btn" aria-label="Next Month">&#8594;</button>
        </form>
    </div>

    <table class="calendar-table my-4">
        <thead>
            <tr>
                <th>Sun</th><th>Mon</th><th>Tue</th><th>Wed</th><th>Thu</th><th>Fri</th><th>Sat</th>
            </tr>
        </thead>
        <tbody>
            {% set ns = namespace(day_ptr=0) %}
            {% set today_str = now.strftime('%Y-%m-%d') %}
            {% for week in range(6) %}
            <tr>
                {% for wd in range(7) %}
                    {% if week == 0 and wd < weekday %}
                        <td></td>
                    {% elif ns.day_ptr < lesson_days|length %}
                        {% set day = lesson_days[ns.day_ptr] %}
                        {% set is_past = day.date < today_str %}
                        <td>
                            <a href="{{ url_for('lessons', year=year, month=month, day=ns.day_ptr) }}" 
                               class="btn calendar-day-btn{% if selected_day_idx|int == ns.day_ptr %} active{% endif %}{% if is_past or day.no_classes %} calendar-day-past{% endif %}" 
                               {% if is_past or day.no_classes %}aria-disabled="true" onclick="return false;"{% endif %}>
                                {{ day.date.split('-')[2] }}
                            </a>
                        </td>
                        {% set ns.day_ptr = ns.day_ptr + 1 %}
                    {% else %}
                        <td></td>
                    {% endif %}
                {% endfor %}
            </tr>
            {% endfor %}
        </tbody>
    </table>

    {% if selected_day %}
        {% if selected_day.no_classes %}
            <div class="alert alert-info">No classes on this day: {{ selected_day.no_classes_reason }}</div>
        {% else %}
            <div class="lesson-container">
                <h2>Badminton Lessons</h2>
                <div class="lessons-card" style="max-width: 700px; width: 100%; min-width: 350px; margin: 0 auto; padding: 2.5rem 2rem; font-size: 1.15rem;">
                    <h1 class="lessons-title">Badminton Lessons</h1>
                    <form id="lesson-booking-form">
                        <div class="form-section">
                            <label><strong>Select Lesson Type:</strong></label>
                            <div class="radio-group">
                                <label class="radio-label"><input type="radio" name="lesson_type" value="group"> Group Lesson (5 Max)</label>
                                <label class="radio-label"><input type="radio" name="lesson_type" value="private"> Private Lesson</label>
                            </div>
                        </div>
                        <div class="form-section">
                            <label for="time_slot"><strong>Select Time Slot:</strong></label><br>
                            <select name="time_slot" id="time_slot">
                                <option value="">-- Select a time slot --</option>
                                {% for slot in selected_day.slots %}
                                    {# data attributes for JS: group count and whether a private booking exists #}
                                    <option value="{{ loop.index0 }}"
                                        data-group-count="{{ slot.group|length }}"
                                        data-has-private="{{ '1' if slot.private else '0' }}"
                                        {% if slot.is_past %}disabled style="color: #888;"{% endif %}>
                                        {{ slot.time }} â€” {% if slot.private %}Private booked{% else %}Group ({{ slot.group|length }} booked){% endif %}
                                        {% if slot.is_past %} - Past{% endif %}
                                    </option>
                                {% endfor %}
                            </select>
                            <div id="slot-info" class="slot-info" style="margin-top:8px; color: #555; font-size:0.95rem;"></div>
                        </div>
                        <div class="form-section">
                            <label for="name"><strong>Your Name:</strong></label>
                            <input type="text" name="name" id="student_name">
                        </div>
                        <div class="form-section">
                            <label for="contact"><strong>Contact:</strong></label>
                            <input type="text" name="contact" id="student_email">
                        </div>
                        <div class="form-section">
                            <label for="recurring_weeks"><strong>Recurring (weeks):</strong></label><br>
                            <select name="recurring_weeks" id="recurring_weeks">
                                <option value="1">One-off (1 week)</option>
                                {% for i in range(2,13) %}
                                    <option value="{{ i }}">{{ i }} weeks</option>
                                {% endfor %}
                            </select>
                        </div>

                        <button type="submit" class="book-btn" id="book-now-btn">Book Slot</button>
                        <input type="hidden" id="slot_idx_select" name="slot_idx_select" value="">
                        <div id="payment-error" class="alert alert-danger d-none"></div>
                    </form>
                </div>
            </div>
        {% endif %}
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const stripe = Stripe('{{ stripe_public_key }}');
    const form = document.getElementById('lesson-booking-form');
    if (!form) return;

    // Expose slot data for the selected day so JS can include exact time/date in the POST
    const lessonSlots = {{ (selected_day.slots if selected_day else []) | tojson }};
    const dayDate = "{{ selected_day.date if selected_day else '' }}";

    form.addEventListener('submit', async function(e) {
        e.preventDefault();

        // Collect form data
        const lessonType = form.lesson_type.value;
        const slotIdx = form.time_slot.value;
        const dayIdx = "{{ selected_day_idx|default(0, true) }}";
        const name = form.student_name.value;
        const contact = form.student_email.value;
        const recurringWeeks = parseInt((form.recurring_weeks && form.recurring_weeks.value) || '1', 10) || 1;

        // Validate selection
        if (!lessonType) {
            alert('Please choose a lesson type (Group or Private).');
            return;
        }
        if (!slotIdx) {
            alert('Please choose a time slot.');
            return;
        }

        // Determine the selected slot time
        const slotIdxNum = parseInt(slotIdx, 10);
        const slotTime = lessonSlots && lessonSlots[slotIdxNum] ? lessonSlots[slotIdxNum].time : null;

        // Send POST request to backend
        const response = await fetch('/create-lesson-booking', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                lesson_type: lessonType,
                slot_idx: slotIdx,
                day_idx: dayIdx,
                name: name,
                contact: contact,
                date: dayDate,
                time: slotTime,
                recurring_weeks: recurringWeeks
            })
        });

        let result = null;
        try {
            result = await response.json();
        } catch (e) {
            const text = await response.text();
            console.error('Create booking non-json response', response.status, text);
            alert('Server error: ' + (text || response.status));
            return;
        }
        console.log('Stripe booking response:', result);

        // If Stripe session id returned, attempt Stripe.js redirect and fallback to session URL
        if (result.sessionId) {
            const res = await stripe.redirectToCheckout({ sessionId: result.sessionId });
            // redirectToCheckout returns an object on error; if it doesn't navigate, fallback
            if (res && res.error) {
                console.warn('stripe.redirectToCheckout returned error:', res.error);
                if (result.url) window.location = result.url;
            }
        } else if (result.url) {
            // Fallback: if server returned a direct URL, navigate there
            window.location = result.url;
        } else {
            const errEl = document.getElementById('payment-error');
            if (errEl) {
                errEl.classList.remove('d-none');
                errEl.textContent = result.error || 'Error creating payment session. Check server logs.';
            } else {
                alert(result.error || 'Error creating payment session. Check server logs.');
            }
        }
    });

    // Update slot info when selection changes
    const slotSelect = document.getElementById('time_slot');
    const slotInfo = document.getElementById('slot-info');
    if (slotSelect && slotInfo) {
        function updateSlotInfo() {
            const opt = slotSelect.options[slotSelect.selectedIndex];
            if (!opt || !opt.value) {
                slotInfo.textContent = '';
                return;
            }
            const groupCount = parseInt(opt.getAttribute('data-group-count') || '0', 10);
            const hasPrivate = opt.getAttribute('data-has-private') === '1';
            if (hasPrivate) {
                slotInfo.textContent = 'This time has a private lesson booked.';
            } else {
                slotInfo.textContent = `Group bookings: ${groupCount} / 5`;
            }
        }
        slotSelect.addEventListener('change', updateSlotInfo);
        // initialize
        updateSlotInfo();
    }
});
</script>
{% endblock %}