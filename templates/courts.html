{% extends "base.html" %}

{% block head %}
{{ super() }}
<script src="https://js.stripe.com/v3/"></script>
{% endblock %}

{% block content %}
<div class="container section">
    <div class="section-header">
        <h1>Courts</h1>
        <form method="get" action="{{ url_for('courts') }}" class="date-picker">
            <label for="date">Select date</label>
            <input type="date" id="date" name="date" value="{{ date_str }}" onchange="this.form.submit()" />
        </form>
    </div>

    <div class="courts-grid">
        {% for court in courts %}
        <div class="court-card">
            <div class="court-header">
                <h3>{{ court.name }}</h3>
                <span class="badge">{{ court.surface }}</span>
            </div>

            <div class="slots">
                {% for slot in time_slots %}
                {% set is_booked = booked_map.get((court.id, slot)) %}
                <div class="slot {{ 'booked' if is_booked else 'available' }}">
                    <div class="slot-time">{{ slot }}</div>
                    <div class="slot-action">
                        {% if is_booked %}
                            <span class="status booked">
                                <i class="fas fa-lock"></i>
                                Booked
                            </span>
                        {% else %}
                            {% if session.user_id %}
                                <button class="btn btn-primary btn-sm book-slot" 
                                        data-court-id="{{ court.id }}" 
                                        data-court-name="{{ court.name }}" 
                                        data-time-slot="{{ slot }}" 
                                        data-date="{{ date_str }}">
                                    <i class="fas fa-calendar-check"></i> Book for $15
                                </button>
                                {% else %}
                                <a class="btn btn-secondary btn-sm" href="{{ url_for('login') }}">
                                    Log in to book
                                </a>
                                {% endif %}
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<style>
.section-header { display:flex; align-items:center; justify-content:space-between; gap:16px; }
.section-header h1 { margin:0; }
.date-picker { display:flex; align-items:center; gap:8px; }
.courts-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:20px; }
.court-card { background:#fff; border-radius:12px; padding:16px; box-shadow:0 2px 8px rgba(0,0,0,0.06); }
.court-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:12px; }
.badge { background:#f1f5f9; color:#0f172a; font-size:12px; padding:4px 8px; border-radius:999px; }
.slots { display:flex; flex-direction:column; gap:8px; max-height:60vh; overflow:auto; padding-right:4px; }
.slot { display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border:1px solid #e5e7eb; border-radius:8px; }
.slot.available { background:#f9fafb; }
.slot.booked { background:#fff7ed; border-color:#fed7aa; }
.slot-time { font-weight:600; }
.status.booked { color:#b45309; font-weight:600; display:flex; align-items:center; gap:6px; }
.btn-sm { padding:6px 10px; font-size:0.9rem; }
.btn-sm:disabled { opacity:0.7; cursor:not-allowed; }
</style>


{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Stripe with your publishable key
    const stripe = Stripe('{{ stripe_public_key }}');
    
    // Handle booking button clicks
    document.querySelectorAll('.book-slot').forEach(button => {
        button.addEventListener('click', async function(e) {
            e.preventDefault();
            
            const button = this;
            const courtId = button.dataset.courtId;
            const courtName = button.dataset.courtName;
            const timeSlot = button.dataset.timeSlot;
            const date = button.dataset.date;
            
            // Disable button to prevent multiple clicks
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-calendar-check"></i> Processing...';
            
            try {
                // Create a payment session with Stripe
                const response = await fetch('/create-court-booking-session', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({
                        court_id: courtId,
                        time_slot: timeSlot,
                        date: date
                    })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                if (!data.sessionId) {
                    throw new Error('Failed to create payment session');
                }
                
                // Redirect to Stripe Checkout
                const result = await stripe.redirectToCheckout({
                    sessionId: data.sessionId
                });
                
                if (result.error) {
                    throw new Error(result.error.message);
                }
                
            } catch (error) {
                console.error('Booking error:', error);
                alert('Error: ' + error.message);
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-calendar-check"></i> Book for $15';
            }
        });
    });
    
    // Show success message if redirected from Stripe
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('payment_success') === 'true') {
        alert('Payment successful! Your court has been booked.');
        // Remove the success parameter from URL
        const newUrl = window.location.pathname + '?' + 
            new URLSearchParams(Array.from(urlParams.entries())
                .filter(([key]) => key !== 'payment_success')
                .map(([k, v]) => [k, v].join('='))
            ).toString();
        window.history.replaceState({}, '', newUrl);
    }
});
</script>
{% endblock %}